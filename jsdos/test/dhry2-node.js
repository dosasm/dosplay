const fs=require("fs");require("../emulators");const backend="x"===process.argv[2]?"dosboxXNode":"dosboxNode",emulators=global.emulators;emulators.pathPrefix="./";const bundle=fs.readFileSync("dhry2.jsdos");let startedAt=null,runStartedAt=Date.now(),prevNonSkippableSleepCount=0,prevSleepCount=0,prevCycles=0;const medianVax=[],medianCycles=[],medianNonSkippableSleepCount=[],medianSleepCount=[],sortFn=(e,n)=>e-n;console.log("Dhrystone 2 Test for "+backend),emulators[backend](bundle).then((e=>{e.events().onStdout((n=>{if(!n.startsWith("dhry2:"))return;null===startedAt&&(startedAt=Date.now());const[o,t,s,l]=n.split(" ");if(console.log("dhry2: "+t+" runs, browser time "+s+" ms, VAX rating "+l),e.asyncifyStats().then((e=>{const n=Date.now()-runStartedAt,o=e.nonSkippableSleepCount-prevNonSkippableSleepCount,t=e.sleepCount-prevSleepCount,s=e.cycles-prevCycles;prevNonSkippableSleepCount=e.nonSkippableSleepCount,prevSleepCount=e.sleepCount,prevCycles=e.cycles,runStartedAt=Date.now(),medianNonSkippableSleepCount.push(1e3*o/n),medianSleepCount.push(1e3*t/n),medianCycles.push(s/n),console.log("dhry2: sleep p/sec: "+Math.round(1e3*t/n)+" , non skippable p/sec: "+Math.round(1e3*o/n)+" , avg cycles p/ms: "+Math.round(s/n))})),medianVax.push(l),"320000"===t){const n=(Date.now()-startedAt)/1e3;medianVax.sort(sortFn),medianNonSkippableSleepCount.sort(sortFn),medianSleepCount.sort(sortFn),medianCycles.sort(sortFn),console.log("Time:",Math.round(10*n)/10,"sec","RpS:",Math.round((t-1e3)/n),"Med VAX:",medianVax[Math.round(medianVax.length/2)]),e.asyncifyStats().then((n=>{console.log("Message sent:",n.messageSent,"(frame",n.messageFrame+")","(sound",n.messageSound+")"),console.log("Message recv:",n.messageReceived),console.log("Sleep count:",n.sleepCount),console.log("Sleep time:",Math.round(n.sleepTime/1e3*10)/10,"sec"),console.log("Avg sleep:",n.sleepTime/n.sleepCount,"ms"),console.log("Med non skippable sleep p/sec: ",Math.round(medianNonSkippableSleepCount[Math.round(medianNonSkippableSleepCount.length/2)])),console.log("Med sleep p/sec:",Math.round(medianSleepCount[Math.round(medianSleepCount.length/2)])),console.log("Med cycles p/ms:",Math.round(medianCycles[Math.round(medianCycles.length/2)])),e.exit()}))}}))})).catch(console.error);